# -*- coding: utf-8 -*-
"""BigQuery_Ethereum_Dataset.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1AHNhkysFCgqGEzj_YYXk8W_jCx8bHVf0
"""

from google.colab import drive
drive.mount('/content/gdrive')

import os
os.environ["GOOGLE_APPLICATION_CREDENTIALS"]="bitcoin-transaction-2-c7d551f5f41d.json"
from google.cloud import bigquery
import pandas as pd

client = bigquery.Client()

query = """
SELECT 
  value AS number_ether,
  from_address AS input,
  to_address AS output,
  receipt_gas_used AS gas_used,
  DATE(timestamp) AS tx_date
FROM
  `bigquery-public-data.crypto_ethereum.transactions` AS transactions,
  `bigquery-public-data.crypto_ethereum.blocks` AS blocks
WHERE TRUE
  AND transactions.block_number = blocks.number
  AND receipt_status = 1

GROUP BY number_ether, input, output, tx_date, gas_used
HAVING tx_date >= '2021-06-01' AND tx_date <= '2021-06-29'
ORDER BY tx_date
LIMIT 30000
"""

query_job = client.query(query)

iterator = query_job.result(timeout=300)
rows = list(iterator)

# Transform the rows into a nice pandas dataframe
df = pd.DataFrame(data=[list(x.values()) for x in rows], columns=list(rows[0].keys()))

# Look at the first 10
df.head(10)

df.to_csv("BigQuery_Ethereum_Dataset.csv", index=False)